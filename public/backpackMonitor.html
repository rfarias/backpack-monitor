<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üìä Backpack Monitor</title>
  <style>
    body{background:#111;color:#eee;font-family:Arial;padding:20px;line-height:1.5;}
    h1{margin-bottom:10px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:6px;border:1px solid #333;text-align:center;}
    th{background:#222;position:relative;cursor:pointer;}
    th:hover{background:#333;}
    .green{background:#133d1d;color:#6f6;}
    .red{background:#3d1313;color:#f99;}
    .blue{background:#13213d;color:#6cf;}
    .gray{background:#2a2a2a;color:#ccc;}
    .filters{margin:15px 0;}
    .filters button{margin-right:6px;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;}
    .filters button.active{background:#555;color:#fff;}
    .tabs button{margin-right:6px;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;}
    .tabs button.active{background:#666;color:#fff;}
    .rsi-low{color:#6f6;font-weight:bold;}
    .rsi-high{color:#f66;font-weight:bold;}
    .rsi-mid{color:#ccc;}
    .atr-low{color:#6f6;font-weight:bold;}
    .atr-mid{color:#ff6;font-weight:bold;}
    .atr-high{color:#f66;font-weight:bold;}
    .info-box{background:#1a1a1a;border:1px solid #333;padding:12px;margin-bottom:15px;border-radius:6px;font-size:14px;color:#ccc;}
    .info-box strong{color:#fff;}
    @keyframes flash{0%{background:#ffae00;}50%{background:#111;}100%{background:#ffae00;}}
    .flash{animation:flash 1s linear infinite;}
    th[title]{cursor:help;}
  </style>
</head>
<body>
  <h1>üìä Backpack Monitor</h1>

  <div class="tabs">
    <button id="tab-futures" class="active" onclick="setTab('futures')">Futuros</button>
    <button id="tab-spot" onclick="setTab('spot')">Spot</button>
    <button id="tab-assets" onclick="setTab('assets')">Dep√≥sitos / Withdraw</button>
  </div>

  <div id="content-futures">
    <div class="info-box">
      <p><strong>Timeframe:</strong> 3 minutos (ou 5m se n√£o houver dados suficientes).</p>
      <p><strong>Como interpretar:</strong></p>
      <ul>
        <li><strong>ATR%</strong>: mede volatilidade. 
          <span style="color:#6f6">Verde = ‚â§0.3%</span>, 
          <span style="color:#ff6">Amarelo = 0.3‚Äì0.7%</span>, 
          <span style="color:#f66">Vermelho = ‚â•0.7%</span>.
        </li>
        <li><strong>RSI</strong>: for√ßa do mercado. Verde ‚â§30, Vermelho ‚â•70.</li>
        <li><strong>BB Width</strong>: largura das Bandas de Bollinger. Valores baixos = consolida√ß√£o, altos = expans√£o.</li>
      </ul>
    </div>

    <div class="filters">
      <button onclick="setFilter('all')" id="btn-all" class="active">Todos</button>
      <button onclick="setFilter('long')" id="btn-long">S√≥ Long</button>
      <button onclick="setFilter('short')" id="btn-short">S√≥ Short</button>
      <button onclick="setFilter('lateral')" id="btn-lateral">S√≥ Lateral</button>
      <button onclick="setFilter('neutral')" id="btn-neutral">S√≥ Neutro</button>
      <button onclick="toggleLiquidity()" id="btn-liq">Ocultar sem liquidez</button>
      <button onclick="toggleNeutros()" id="btn-neutro">Ocultar neutros</button>
    </div>

    <table id="tbl-futures">
      <thead>
        <tr>
          <th>#</th>
          <th data-key="symbol">Symbol</th>
          <th data-key="lastPrice">Price</th>
          <th data-key="atrRel" title="ATR% mede volatilidade">ATR%</th>
          <th data-key="bbWidth" title="Largura das Bandas de Bollinger">BB Width</th>
          <th data-key="rsi" title="RSI (For√ßa Relativa)">RSI</th>
          <th data-key="volumeUSD">Liq</th>
          <th data-key="oiUSD">OI</th>
          <th data-key="liqOI">Liq/OI</th>
          <th data-key="score">Score</th>
          <th data-key="decision">Decis√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="content-spot" style="display:none;">
    <h2>üí∞ Mercados Spot</h2>
    <table id="tbl-spot">
      <thead>
        <tr>
          <th>#</th>
          <th>Symbol</th>
          <th>Base</th>
          <th>Quote</th>
          <th>Pre√ßo</th>
          <th>Volume 24h</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="content-assets" style="display:none;">
    <h2>üè¶ Dep√≥sitos & Withdraws</h2>
    <table id="tbl-assets">
      <thead>
        <tr>
          <th>#</th>
          <th>Moeda</th>
          <th>Nome</th>
          <th>Dep√≥sito</th>
          <th>Withdraw</th>
          <th>Min Withdraw</th>
          <th>Taxa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
let currentTab="futures", currentFilter="all", hideNoLiquidity=false, hideNeutros=false;
let sortKey="score", sortDir="desc", previousStates={};

const usdFmt=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"});
const rsiClass=rsi=>rsi<=30?"rsi-low":rsi>=70?"rsi-high":"rsi-mid";
const atrClass=a=>a*100<=0.3?"atr-low":a*100>=0.7?"atr-high":"atr-mid";

function setTab(tab){
  currentTab=tab;
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById("tab-"+tab).classList.add("active");
  document.querySelectorAll("[id^='content-']").forEach(d=>d.style.display="none");
  document.getElementById("content-"+tab).style.display="block";
  if(tab==="futures") loadFutures();
  if(tab==="spot") loadSpot();
  if(tab==="assets") loadAssets();
}

function setFilter(f){currentFilter=f;document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));document.getElementById("btn-"+f).classList.add("active");loadFutures();}
function toggleLiquidity(){hideNoLiquidity=!hideNoLiquidity;const b=document.getElementById("btn-liq");b.classList.toggle("active",hideNoLiquidity);b.textContent=hideNoLiquidity?"Mostrar sem liquidez":"Ocultar sem liquidez";loadFutures();}
function toggleNeutros(){hideNeutros=!hideNeutros;const b=document.getElementById("btn-neutro");b.classList.toggle("active",hideNeutros);b.textContent=hideNeutros?"Mostrar neutros":"Ocultar neutros";loadFutures();}

async function loadFutures(){
  const resp=await fetch("/api/data");
  let data=await resp.json();

  // Mostrar tamb√©m mercados sem valor (com placeholders)
  data.forEach(m=>{
    m.lastPrice=m.lastPrice||0;
    m.atrRel=m.atrRel||0;
    m.bbWidth=m.bbWidth||0;
    m.rsi=m.rsi||50;
    m.volumeUSD=m.volumeUSD||0;
    m.oiUSD=m.oiUSD||0;
    m.liqOI=m.liqOI||0;
    m.decision=m.decision||"neutral";
  });

  if(currentFilter!=="all") data=data.filter(m=>m.decision===currentFilter);
  if(hideNoLiquidity) data=data.filter(m=>m.volumeUSD>0);
  if(hideNeutros) data=data.filter(m=>m.decision!=="neutral");

  data.sort((a,b)=>{
    let va=a[sortKey],vb=b[sortKey];
    if(typeof va==="string"){va=va.toUpperCase();vb=vb.toUpperCase();}
    if(va<vb)return sortDir==="asc"?-1:1;
    if(va>vb)return sortDir==="asc"?1:-1;
    return 0;
  });

  const tb=document.querySelector("#tbl-futures tbody");
  tb.innerHTML="";
  data.forEach((m,i)=>{
    const tr=document.createElement("tr");
    tr.className=m.decision==="long"?"green":m.decision==="short"?"red":m.decision==="lateral"?"blue":"gray";
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${m.symbol}</td>
      <td>${m.lastPrice?usdFmt.format(m.lastPrice):"‚Äî"}</td>
      <td class="${atrClass(m.atrRel)}">${(m.atrRel*100).toFixed(3)}%</td>
      <td>${m.bbWidth.toFixed(4)}</td>
      <td class="${rsiClass(m.rsi)}">${m.rsi.toFixed(1)}</td>
      <td>${m.volumeUSD?usdFmt.format(m.volumeUSD):"‚Äî"}</td>
      <td>${m.oiUSD?usdFmt.format(m.oiUSD):"‚Äî"}</td>
      <td>${m.liqOI.toFixed(4)}</td>
      <td>${m.score||0}</td>
      <td>${m.decision.toUpperCase()}</td>`;
    tb.appendChild(tr);
  });
}

async function loadSpot(){
  const resp=await fetch("https://api.backpack.exchange/api/v1/spot/markets");
  const data=await resp.json();
  const tb=document.querySelector("#tbl-spot tbody");
  tb.innerHTML="";
  data.forEach((m,i)=>{
    const price=m.lastPrice?usdFmt.format(+m.lastPrice):"‚Äî";
    tb.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${m.symbol}</td>
        <td>${m.baseAsset}</td>
        <td>${m.quoteAsset}</td>
        <td>${price}</td>
        <td>${m.volume?usdFmt.format(+m.volume):"‚Äî"}</td>
        <td>${m.status}</td>
      </tr>`;
  });
}

async function loadAssets(){
  const resp=await fetch("https://api.backpack.exchange/api/v1/assets");
  const data=await resp.json();
  const tb=document.querySelector("#tbl-assets tbody");
  tb.innerHTML="";
  data.forEach((a,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${a.symbol}</td>
        <td>${a.name||"‚Äî"}</td>
        <td>${a.depositEnabled?"‚úÖ":"‚ùå"}</td>
        <td>${a.withdrawEnabled?"‚úÖ":"‚ùå"}</td>
        <td>${a.withdrawMinAmount||"‚Äî"}</td>
        <td>${a.withdrawFee||"‚Äî"}</td>
      </tr>`;
  });
}

document.querySelectorAll("th[data-key]").forEach(th=>{
  th.addEventListener("click",()=>{
    const key=th.getAttribute("data-key");
    if(sortKey===key){sortDir=sortDir==="asc"?"desc":"asc";}else{sortKey=key;sortDir="desc";}
    loadFutures();
  });
});

loadFutures();
setInterval(()=>{if(currentTab==="futures")loadFutures();if(currentTab==="spot")loadSpot();if(currentTab==="assets")loadAssets();},30000);
</script>
</body>
</html>
