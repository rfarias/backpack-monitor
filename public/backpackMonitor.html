<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Backpack Monitor</title>
  <style>
    body{background:#111;color:#eee;font-family:Arial;padding:20px;line-height:1.5;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:6px;border:1px solid #333;text-align:center;cursor:pointer;}
    th{background:#222;position:relative;}
    th:hover{background:#333;}
    .green{background:#133d1d;color:#6f6;}   /* Long */
    .red{background:#3d1313;color:#f99;}     /* Short */
    .blue{background:#13213d;color:#6cf;}   /* Lateral */
    .gray{background:#2a2a2a;color:#ccc;}   /* Neutral */
    .aguardando{background:#1e1e1e;color:#777;font-style:italic;} /* Ainda nÃ£o listado */
    .filters {margin:15px 0;}
    .filters button {
      margin-right:6px;
      padding:6px 12px;
      border:none;
      border-radius:5px;
      cursor:pointer;
      font-weight:bold;
    }
    .filters button.active {background:#555;color:#fff;}
    /* RSI cores */
    .rsi-low { color:#6f6; font-weight:bold; }
    .rsi-high { color:#f66; font-weight:bold; }
    .rsi-mid { color:#ccc; }
    /* ATR cores */
    .atr-low { color:#6f6; font-weight:bold; }
    .atr-mid { color:#ff6; font-weight:bold; }
    .atr-high { color:#f66; font-weight:bold; }
    /* Tooltip */
    th[title] { cursor: help; }
    .info-box {
      background:#1a1a1a;
      border:1px solid #333;
      padding:12px;
      margin-bottom:15px;
      border-radius:6px;
      font-size:14px;
      color:#ccc;
    }
    .info-box strong { color:#fff; }
    /* AnimaÃ§Ã£o de alerta */
    @keyframes flash {
      0% { background-color: #ffae00; }
      50% { background-color: #111; }
      100% { background-color: #ffae00; }
    }
    .flash {
      animation: flash 1s linear infinite;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Backpack Monitor</h1>
  <div class="info-box">
    <p><strong>Timeframe:</strong> Indicadores calculados no grÃ¡fico de <strong>3 minutos</strong> (fallback 5m).</p>
    <p><strong>ATR%</strong>: mede volatilidade â€” verde â‰¤0.3%, amarelo 0.3â€“0.7%, vermelho â‰¥0.7%</p>
    <p><strong>RSI</strong>: forÃ§a do mercado â€” verde â‰¤30, vermelho â‰¥70.</p>
    <p><strong>DecisÃ£o:</strong> verde = Long, vermelho = Short, azul = Lateral, cinza = Neutro, cinza-escuro = Aguardando listagem.</p>
  </div>

  <div class="filters">
    <button onclick="setFilter('all')" id="btn-all" class="active">Todos</button>
    <button onclick="setFilter('long')" id="btn-long">SÃ³ Long</button>
    <button onclick="setFilter('short')" id="btn-short">SÃ³ Short</button>
    <button onclick="setFilter('lateral')" id="btn-lateral">SÃ³ Lateral</button>
    <button onclick="setFilter('neutral')" id="btn-neutral">SÃ³ Neutro</button>
    <button onclick="setFilter('aguardando')" id="btn-aguardando">SÃ³ Aguardando</button>
    <button onclick="toggleLiquidity()" id="btn-liq">Ocultar sem liquidez</button>
    <button onclick="toggleNeutros()" id="btn-neutro">Ocultar neutros</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>#</th>
        <th data-key="symbol">Symbol</th>
        <th data-key="lastPrice">Price</th>
        <th data-key="atrRel">ATR%</th>
        <th data-key="bbWidth">BB Width</th>
        <th data-key="rsi">RSI</th>
        <th data-key="volumeUSD">Liq</th>
        <th data-key="oiUSD">OI</th>
        <th data-key="liqOI">Liq/OI</th>
        <th data-key="score">Score</th>
        <th data-key="decision">DecisÃ£o</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
let currentFilter = "all";
let hideNoLiquidity = false;
let hideNeutros = false;
let sortKey = "score";
let sortDir = "desc";
let previousStates = {};

function setFilter(f){
  currentFilter = f;
  document.querySelectorAll(".filters button").forEach(btn=>btn.classList.remove("active"));
  const el = document.getElementById("btn-"+f);
  if (el) el.classList.add("active");
  load();
}

function toggleLiquidity(){
  hideNoLiquidity = !hideNoLiquidity;
  const btn = document.getElementById("btn-liq");
  btn.classList.toggle("active", hideNoLiquidity);
  btn.textContent = hideNoLiquidity ? "Mostrar sem liquidez" : "Ocultar sem liquidez";
  load();
}

function toggleNeutros(){
  hideNeutros = !hideNeutros;
  const btn = document.getElementById("btn-neutro");
  btn.classList.toggle("active", hideNeutros);
  btn.textContent = hideNeutros ? "Mostrar neutros" : "Ocultar neutros";
  load();
}

const usdFmt = new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"});
function rsiClass(rsi){if(rsi<=30)return"rsi-low";if(rsi>=70)return"rsi-high";return"rsi-mid";}
function atrClass(atrRel){const p=atrRel*100;if(p<=0.3)return"atr-low";if(p>=0.7)return"atr-high";return"atr-mid";}

async function load(){
  try {
    const resp = await fetch("/api/data");
    let data = await resp.json();

    // mostra todos, inclusive os aguardando listagem (sem preÃ§o)
    data.forEach(d => {
      if (!d.lastPrice || d.lastPrice === 0) {
        d.decision = "aguardando";
        d.atrRel = d.rsi = d.bbWidth = d.volumeUSD = d.oiUSD = d.liqOI = d.score = 0;
      }
    });

    if (currentFilter !== "all") {
      data = data.filter(m => m.decision === currentFilter);
    }
    if (hideNoLiquidity) data = data.filter(m => (m.volumeUSD ?? 0) > 0);
    if (hideNeutros) data = data.filter(m => m.decision !== "neutral");

    data.sort((a,b)=>{
      const va=a[sortKey]??0, vb=b[sortKey]??0;
      if(typeof va==="string"||typeof vb==="string")return sortDir==="asc"?va.localeCompare(vb):vb.localeCompare(va);
      return sortDir==="asc"?va-vb:vb-va;
    });

    const tb=document.querySelector("#tbl tbody");
    tb.innerHTML="";
    data.forEach((m,i)=>{
      const tr=document.createElement("tr");
      if(m.decision==="long")tr.className="green";
      else if(m.decision==="short")tr.className="red";
      else if(m.decision==="lateral")tr.className="blue";
      else if(m.decision==="aguardando")tr.className="aguardando";
      else tr.className="gray";

      // alerta se virar neutro
      if(previousStates[m.symbol] && previousStates[m.symbol]!=="neutral" && m.decision==="neutral"){
        tr.classList.add("flash");
        setTimeout(()=>tr.classList.remove("flash"),30000);
      }
      previousStates[m.symbol]=m.decision;

      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${m.symbol}</td>
        <td>${m.lastPrice?usdFmt.format(m.lastPrice):"-"}</td>
        <td class="${atrClass(m.atrRel)}">${m.atrRel?(m.atrRel*100).toFixed(3)+"%":"-"}</td>
        <td>${m.bbWidth?m.bbWidth.toFixed(4):"-"}</td>
        <td class="${rsiClass(m.rsi)}">${m.rsi?m.rsi.toFixed(1):"-"}</td>
        <td>${m.volumeUSD?usdFmt.format(m.volumeUSD):"-"}</td>
        <td>${m.oiUSD?usdFmt.format(m.oiUSD):"-"}</td>
        <td>${m.liqOI?m.liqOI.toFixed(4):"-"}</td>
        <td>${m.score||0}</td>
        <td>${m.decision.toUpperCase()}</td>
      `;
      tb.appendChild(tr);
    });
  } catch (err) {
    console.error("Erro ao carregar:", err);
  }
}

document.querySelectorAll("th[data-key]").forEach(th=>{
  th.addEventListener("click",()=>{
    const key=th.getAttribute("data-key");
    if(sortKey===key){sortDir=sortDir==="asc"?"desc":"asc";}
    else{sortKey=key;sortDir="desc";}
    load();
  });
});

load();
setInterval(load,30000);
</script>
</body>
</html>
