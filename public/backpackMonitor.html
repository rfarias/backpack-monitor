<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Backpack Monitor</title>
<style>
body{background:#111;color:#eee;font-family:Arial;padding:20px;}
nav{margin-bottom:15px;}
nav button{margin-right:10px;padding:8px 16px;cursor:pointer;border:none;border-radius:6px;background:#333;color:#fff;font-weight:bold;}
nav button.active{background:#555;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:6px;border:1px solid #333;text-align:center;}
th{background:#222;}
.green{background:#133d1d;color:#6f6;}
.red{background:#3d1313;color:#f99;}
.blue{background:#13213d;color:#6cf;}
.gray{background:#2a2a2a;color:#ccc;}
.loading{padding:20px;text-align:center;color:#aaa;}
.networks{font-size:13px;color:#ccc;}
</style>
</head>
<body>
<h1>üìä Backpack Monitor</h1>

<nav>
  <button id="tabPerp" class="active" onclick="switchTab('perp')">Perp√©tuos</button>
  <button id="tabSpot" onclick="switchTab('spot')">Spot</button>
  <button id="tabTransfer" onclick="switchTab('transfer')">Dep√≥sitos / Withdraw</button>
</nav>

<div id="content">
  <div id="perp" class="tab"></div>
  <div id="spot" class="tab" style="display:none"></div>
  <div id="transfer" class="tab" style="display:none"></div>
</div>

<script>
let currentTab="perp";
let controller;

function switchTab(tab){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("tab"+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add("active");
  document.querySelectorAll(".tab").forEach(div=>div.style.display="none");
  document.getElementById(tab).style.display="block";
  currentTab=tab;
  loadData();
}

async function loadData(){
  if(controller)controller.abort();
  controller=new AbortController();
  const div=document.getElementById(currentTab);
  div.innerHTML='<div class="loading">‚è≥ Carregando dados...</div>';
  let url="/api/"+(currentTab==="perp"?"data":currentTab);
  try{
    const resp=await fetch(url,{signal:controller.signal});
    const data=await resp.json();
    if(currentTab==="transfer")renderTransfer(data);
    else renderMarkets(data);
  }catch(e){
    if(e.name!=="AbortError")div.innerHTML='<div class="loading">Erro ao carregar dados.</div>';
  }
}

function renderMarkets(data){
  const div=document.getElementById(currentTab);
  if(!data||!data.length){div.innerHTML='<div class="loading">Nenhum dado dispon√≠vel.</div>';return;}
  const headers=currentTab==="perp"?
    ["Symbol","Price","ATR%","RSI","BB Width","Volume (USD)","Open Interest (USD)","Liq/OI","Score","Decis√£o"]:
    ["Symbol","Price","Volume (USD)"];
  let html="<table><thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr></thead><tbody>";
  data.forEach(m=>{
    let cls="gray";
    if(m.decision==="long")cls="green";
    else if(m.decision==="short")cls="red";
    else if(m.decision==="lateral")cls="blue";
    html+="<tr class='"+cls+"'>";
    if(currentTab==="perp"){
      html+=`
        <td>${m.symbol}</td>
        <td>${m.lastPrice?.toFixed(4)||"-"}</td>
        <td>${(m.atrRel*100).toFixed(3)}%</td>
        <td>${m.rsi?.toFixed(1)||"-"}</td>
        <td>${m.bbWidth?.toFixed(4)||"-"}</td>
        <td>${m.volumeUSD?.toFixed(0)||"-"}</td>
        <td>${m.oiUSD?.toFixed(0)||"-"}</td>
        <td>${m.liqOI?.toFixed(3)||"-"}</td>
        <td>${m.score||0}</td>
        <td>${m.decision||"neutral"}</td>`;
    }else{
      html+=`
        <td>${m.symbol}</td>
        <td>${m.lastPrice?.toFixed(4)||"-"}</td>
        <td>${m.volumeUSD?.toFixed(0)||"-"}</td>`;
    }
    html+="</tr>";
  });
  html+="</tbody></table>";
  div.innerHTML=html;
}

function renderTransfer(data){
  const div=document.getElementById("transfer");
  if(!data||!data.length){div.innerHTML='<div class="loading">Nenhum ativo encontrado.</div>';return;}
  let html="<table><thead><tr><th>Ativo</th><th>Redes dispon√≠veis</th></tr></thead><tbody>";
  data.forEach(a=>{
    const nets=(a.networks||[]).map(n=>`${n.network} ‚Äî Dep√≥sito: ${n.deposit?"üü¢":"üî¥"} | Saque: ${n.withdraw?"üü¢":"üî¥"}`).join("<br>");
    html+=`<tr><td>${a.symbol}</td><td class="networks">${nets}</td></tr>`;
  });
  html+="</tbody></table>";
  div.innerHTML=html;
}

loadData();
setInterval(loadData,30000);
</script>
</body>
</html>
