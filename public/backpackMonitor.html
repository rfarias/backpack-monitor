<script>
let currentTab = "perp";
let currentFilter = "all";
let hideNoLiquidity = false;
let hideNeutros = false;
let sortKey = "score";
let sortDir = "desc";
let previousStates = {};
let loadId = 0;

const usdFmt = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" });

function switchTab(tab){
  currentTab = tab;
  document.querySelectorAll(".tabs button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById("tab-"+tab).classList.add("active");
  document.getElementById("col-oi").style.display = (tab === "perp" ? "" : "none");
  document.getElementById("filters").style.display = (tab === "transfer" ? "none" : "block");
  document.getElementById("info-box").style.display = (tab === "transfer" ? "none" : "block");
  load();
}

function setFilter(f){
  currentFilter=f;
  document.querySelectorAll(".filters button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById("btn-"+f).classList.add("active");
  load();
}

function toggleLiquidity(){
  hideNoLiquidity=!hideNoLiquidity;
  const btn=document.getElementById("btn-liq");
  btn.classList.toggle("active",hideNoLiquidity);
  btn.textContent=hideNoLiquidity?"Mostrar sem liquidez":"Ocultar sem liquidez";
  load();
}
function toggleNeutros(){
  hideNeutros=!hideNeutros;
  const btn=document.getElementById("btn-neutro");
  btn.classList.toggle("active",hideNeutros);
  btn.textContent=hideNeutros?"Mostrar neutros":"Ocultar neutros";
  load();
}
function rsiClass(rsi){if(rsi<=30)return"rsi-low";if(rsi>=70)return"rsi-high";return"rsi-mid";}
function atrClass(atr){const atrPct=atr*100;if(atrPct<=0.3)return"atr-low";if(atrPct>=0.7)return"atr-high";return"atr-mid";}

async function load(){
  const id = ++loadId;
  const endpoint = currentTab==="perp"?"/api/data":currentTab==="spot"?"/api/spot":"/api/transfer";
  const tb=document.querySelector("#tbl tbody");
  tb.innerHTML="<tr><td colspan='12' class='loading'>Carregando...</td></tr>";

  try {
    const resp = await fetch(endpoint);
    const data = await resp.json();
    if (id !== loadId) return; // ignora se aba mudou antes da resposta
    renderTable(data);
  } catch (e) {
    if (id === loadId)
      tb.innerHTML="<tr><td colspan='12' class='loading'>Erro ao carregar</td></tr>";
  }
}

function renderTable(data){
  const tb=document.querySelector("#tbl tbody");
  const th=document.querySelector("#tbl-head tr");
  tb.innerHTML="";

  // === Transfer ===
  if(currentTab==="transfer"){
    th.innerHTML=`<th>#</th><th>Ativo</th><th>Redes disponíveis</th>`;
    data.forEach((m,i)=>{
      const networks=(m.networks||[]).map(n=>`
        <div class="network-tag ${n.deposit&&n.withdraw?'net-ok':'net-off'}">
          ${n.chain||n.network} ${n.deposit?'✅':'❌'}Dep / ${n.withdraw?'✅':'❌'}Wdr
        </div>`).join("");
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${i+1}</td><td>${m.symbol}</td><td>${networks||"-"}</td>`;
      tb.appendChild(tr);
    });
    return;
  }

  // === Cabeçalhos específicos ===
  if(currentTab==="spot"){
    th.innerHTML=`<th>#</th><th>Symbol</th><th>Preço</th><th>Volume 24h</th>
      <th>Depth ±0.2%</th><th>Imbalance</th><th>Spot OI Proxy</th><th>Score</th>`;
  } else {
    th.innerHTML=`<th>#</th><th data-key="symbol">Symbol</th><th data-key="lastPrice">Price</th>
    <th data-key="atrRel">ATR%</th><th data-key="bbWidth">BB Width</th><th data-key="rsi">RSI</th>
    <th data-key="volumeUSD">Volume</th><th data-key="oiUSD" id="col-oi">OI</th>
    <th data-key="decision">Decisão</th><th data-key="score">Score</th>`;
    document.getElementById("col-oi").style.display=(currentTab==="perp"?"":"none");
  }

  // === Filtros padrão ===
  if(currentFilter!=="all" && currentTab!=="spot")
    data=data.filter(m=>m.decision===currentFilter);
  if(hideNoLiquidity) data=data.filter(m=>m.volumeUSD>0 || m.volume>0);
  if(hideNeutros && currentTab!=="spot")
    data=data.filter(m=>m.decision!=="neutral");

  // === Ordenação ===
  data.sort((a,b)=>{
    let va=a[sortKey],vb=b[sortKey];
    if(typeof va==="string"){va=va.toUpperCase();vb=vb.toUpperCase();}
    if(va<vb)return sortDir==="asc"?-1:1;
    if(va>vb)return sortDir==="asc"?1:-1;
    return 0;
  });

  // === Renderização ===
  data.forEach((m,i)=>{
    const tr=document.createElement("tr");

    if(currentTab==="spot"){
      tr.className="gray";
      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${m.symbol}</td>
        <td>${m.price || "-"}</td>
        <td>${m.volume || "-"}</td>
        <td>${m.depthNear || "-"}</td>
        <td>${m.imbalance || "-"}</td>
        <td>${m.spotOIproxy || "-"}</td>
        <td><b>${m.score || "-"}</b></td>`;
    } else {
      if(m.decision==="long")tr.className="green";
      else if(m.decision==="short")tr.className="red";
      else if(m.decision==="lateral")tr.className="blue";
      else tr.className="gray";

      if(previousStates[m.symbol] && previousStates[m.symbol]!=="neutral" && m.decision==="neutral"){
        tr.classList.add("flash");
        setTimeout(()=>tr.classList.remove("flash"),30000);
      }
      previousStates[m.symbol]=m.decision;

      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${m.symbol}</td>
        <td>${m.lastPrice>0?usdFmt.format(m.lastPrice):"-"}</td>
        <td class="${atrClass(m.atrRel||0)}">${m.lastPrice>0?(m.atrRel*100).toFixed(3)+"%":"-"}</td>
        <td>${m.lastPrice>0?(m.bbWidth?.toFixed(4)||"-"):"-"}</td>
        <td class="${rsiClass(m.rsi||0)}">${m.lastPrice>0?(m.rsi?.toFixed(1)||"-"):"-"}</td>
        <td>${m.lastPrice>0?usdFmt.format(m.volumeUSD):"-"}</td>
        ${currentTab==="perp"?`<td>${usdFmt.format(m.oiUSD||0)}</td>`:""}
        <td>${m.decision?.toUpperCase()||"-"}</td>
        <td>${m.score||0}</td>`;
    }
    tb.appendChild(tr);
  });
}

// === Ordenação por clique no cabeçalho ===
document.querySelectorAll("th[data-key]").forEach(th=>{
  th.addEventListener("click",()=>{
    const key=th.getAttribute("data-key");
    if(sortKey===key)sortDir=sortDir==="asc"?"desc":"asc";
    else{sortKey=key;sortDir="desc";}
    load();
  });
});

load();
setInterval(load,30000);
</script>
